<?xml version="1.0" encoding="UTF-8" ?>

<Section xmlns="urn:com.io7m.structural:8:0"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         id="efdda8e2-5315-486b-98a5-782c2e68a04a"
         title="Tutorial">

  <Subsection title="Overview">
    <Paragraph>
      This section of the documentation provides an informal tutorial describing how to set up a
      <Term type="package">northpike</Term>
      server along with an agent to execute work
      <LinkFootnote target="a927fac5-f2e2-4f62-a61b-3f97597b80e7"/>.
      We'll assume that the server will be running on a UNIX-like platform,
      so the setup commands will be phrased as Bourne shell invocations. We'll be setting up a
      <Term type="package">northpike</Term>
      server at <Term type="address">northpike.example.com</Term>, and we'll pretend that
      <Term type="address">northpike.example.com</Term>
      has the IPv4 address
      <Term type="address">100.100.100.100</Term>
      and IPv6 address
      <Term type="address">cafe:cafe::1</Term>. Substitute your own domain, host names, and IP addresses as necessary!
    </Paragraph>
  </Subsection>

  <Subsection title="Server"
              id="656d335d-211e-4979-bbaa-91ce9ad5ed8a">
    <Subsection title="Database">
      <Paragraph>
        The first step required is to set up a working database. The <Term type="package">northpike</Term> server uses
        <LinkExternal target="https://www.postgresql.org">PostgreSQL</LinkExternal>
        as the database in which it stores all persistent state. Assuming that a database has been set up and is
        listening on
        <Term type="address">db.example.com</Term>, an
        <Link target="e6639080-328c-4695-a2a0-e155d0c39e0b">owner</Link>
        should be configured with a strong password. We connect to the database as the superuser and run the following
        <Term type="command">psql</Term>
        commands:
      </Paragraph>
      <FormalItem title="Owner Role">
        <Verbatim><![CDATA[
postgres=> CREATE ROLE northpike_install WITH PASSWORD 'f1c0fbbf52f9f9e3684cbac3d405d6d64cc9229a42a7a2484fc878af2d1605eb';
postgres=> ALTER ROLE northpike_install WITH LOGIN;
postgres=> ALTER ROLE northpike_install WITH CREATEROLE;
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        Then, a database should be created, owned by the owner role:
      </Paragraph>
      <FormalItem title="Database Creation">
        <Verbatim><![CDATA[
postgres=> CREATE DATABASE northpike WITH OWNER northpike_install;
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        The <Term type="package">northpike</Term> server will automatically create any other database roles it needs
        when it starts up. We'll assume the use of the password
        <Term type="constant">2d28cffd837cc32b7828733d0f89898e</Term>
        for the other roles; you should pick stronger passwords in production.
      </Paragraph>
    </Subsection>

    <Subsection title="Idstore">
      <Paragraph>
        The <Term type="package">northpike</Term> server uses
        <LinkExternal target="https://www.io7m.com/software/idstore">idstore</LinkExternal>
        to handle authentication and user management. Rather than duplicate the installation documentation for
        <Term type="package">idstore</Term>
        here, we'll assume there's a running
        <Term type="package">idstore</Term>
        server at <Term type="address">idstore.example.com</Term>.
      </Paragraph>
      <Paragraph id="c6897721-eab0-447b-845c-eb85d92f5c19">
        We'll assume there's a user called <Term type="expression">grouch</Term> declared in the
        <Term type="package">idstore</Term>
        server with user ID
        <Term type="constant">f71154c9-f7ac-472c-88fe-0c367f679a7a</Term>. The
        <Term type="expression">grouch</Term>
        user will be configured to be the administrator of the <Term type="package">northpike</Term> server. For the
        sake of example, the <Term type="expression">grouch</Term>'s password is
        <Term type="constant">ilovetrash</Term>.
      </Paragraph>
    </Subsection>

    <Subsection title="Podman/OCI">
      <Subsection title="Overview">
        <Paragraph>
          The recommended way to run the <Term type="package">northpike</Term> server is via the provided
          <Link target="459da445-e973-4100-a163-5c3198773796">OCI</Link>
          image under
          <LinkExternal target="https://podman.io/">Podman</LinkExternal>. The
          <Term type="package">northpike</Term>
          server does not require elevated privileges of any kind, and the OCI image can be run as any user.
        </Paragraph>
      </Subsection>

      <Subsection title="System Users">
        <Paragraph>
          We'll assume that the host system has a user named <Term type="user">_northpike</Term> with a primary group of
          <Term type="group">_northpike</Term>. This is the user that will be used to run the OCI image. The commands
          required to create system users are UNIX-system specific, so the exact commands aren't covered here. Defer to
          the system administration documentation for your particular platform.
        </Paragraph>
      </Subsection>

      <Subsection title="Directories">
        <Paragraph>
          The OCI image for the <Term type="package">northpike</Term> server is completely immutable and stateless.
          Containers using the image therefore need to have a few external volumes mounted in order to read
          configuration information and to store any persistent state that exists outside the database. We'll assume
          that we have these directories existing on the host system:
        </Paragraph>
        <FormalItem title="Directories">
          <ListUnordered>
            <Item>
              <Term type="file">/storage/northpike/etc</Term>
              - A directory that will hold the configuration file for the server.
            </Item>
            <Item>
              <Term type="file">/storage/northpike/data</Term>
              - A directory that will hold temporary data created by the server.
            </Item>
            <Item>
              A directory that holds
              <Link target="61f9a518-82b3-4a5d-93f7-0ec571ff0579">TLS</Link>
              certificates.
            </Item>
          </ListUnordered>
        </FormalItem>
      </Subsection>

      <Subsection title="TLS"
                  id="61f9a518-82b3-4a5d-93f7-0ec571ff0579">
        <Paragraph>
          The <Term type="package">northpike</Term> server has strong support for
          <LinkExternal target="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</LinkExternal>, including
          automatic certificate rotation to directly support the use of the
          <LinkExternal target="https://en.wikipedia.org/wiki/Automatic_Certificate_Management_Environment">ACME
          </LinkExternal>
          protocol. Using TLS is strongly recommended, but this section can be skipped if you want to defer setting up
          TLS for the purposes of experimentation.
        </Paragraph>
        <Paragraph>
          We'll assume that TLS certificates are being written into a directory on the host system by an ACME client
          such as
          <LinkExternal target="https://www.io7m.com/software/certusine">certusine</LinkExternal>. For this example,
          we'll assume that the directory on the host system is <Term type="file">/storage/certificates</Term>, and that
          there is, for example, a file
          <Term type="file">/storage/certificates/full_chain.pem</Term>
          that contains the full certificate chain for the server.
        </Paragraph>
        <Paragraph>
          The <Term type="package">northpike</Term> server supports a custom keystore and truststore implementation
          called <LinkExternal target="https://www.io7m.com/software/canonmill">Canonmill</LinkExternal> that allows for
          the proper reloading of certificates. It is possible to use standard Java JKS keystores, but we'll use
          Canonmill here for ease of administration. We need to create a Canonmill keystore configuration file at
          <Term type="file">/northpike/certificates/keystore.xml</Term>
          with the following contents:
        </Paragraph>
        <FormalItem title="Keystore Config">
          <Verbatim><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>
<Keystore xmlns="urn:com.io7m.canonmill.keystore:1"
          BaseDirectory="/northpike/certificates">
  <Key         Name="northpike.example.com" File="private.key"/>
  <Certificate Name="northpike.example.com" File="full_chain.pem"/>
</Keystore>
]]></Verbatim>
        </FormalItem>
        <Paragraph>
          With this keystore configuration, when the server creates the various listening sockets for the services it
          exposes on
          <Term type="address">northpike.example.com</Term>, it will use the private key at
          <Term type="file">/northpike/certificates/private.key</Term>. Accordingly, clients connecting to the sockets
          will be served certificates from
          <Term type="file">/northpike/certificates/full_chain.pem</Term>. The server will periodically reload these
          files, so an ACME client can safely replace them at any time and the server will switch to the new
          certificates after a short delay.
        </Paragraph>
      </Subsection>

      <Subsection title="Telemetry"
                  id="8fa003b6-d2e8-4a45-af75-0f2ae3c74f3a">
        <Paragraph>
          The <Term type="package">northpike</Term> server is heavily instrumented with
          <LinkExternal target="https://opentelemetry.io">OpenTelemetry</LinkExternal>. Setting up a server to receive
          OpenTelemetry data is far outside the scope of this documentation. If you don't want to use telemetry, this
          section can be skipped. For production use, we currently recommend the
          <LinkExternal target="https://grafana.com/">Grafana</LinkExternal>
          servers;
          <LinkExternal target="https://grafana.com/oss/mimir/">Mimir</LinkExternal>
          for metrics,
          <LinkExternal target="https://grafana.com/docs/loki/latest/">Loki</LinkExternal>
          for logs, and
          <LinkExternal target="https://grafana.com/docs/tempo/latest/">Tempo</LinkExternal>
          for traces.
        </Paragraph>
        <Paragraph>
          We'll assume that the following OpenTelemetry collectors are already running:
        </Paragraph>
        <FormalItem title="Telemetry Services">
          <ListUnordered>
            <Item>
              A server that can collect <Term type="term">logs</Term> at
              <Term type="address">http://logs.telemetry.example.com:4317</Term>.
            </Item>
            <Item>
              A server that can collect <Term type="term">metrics</Term> at
              <Term type="address">http://metrics.telemetry.example.com:4317</Term>.
            </Item>
            <Item>
              A server that can collect <Term type="term">traces</Term> at
              <Term type="address">http://traces.telemetry.example.com:4317</Term>.
            </Item>
          </ListUnordered>
        </FormalItem>
        <Paragraph>
          It is not required that all three be present: If you only want to collect metrics, for example, then only the
          metrics server is necessary.
        </Paragraph>
      </Subsection>

      <Subsection title="Configuration File">
        <Paragraph>
          We now place all of the above information into the server configuration file. It is recommended that the
          configuration file be edited in an IDE such as
          <LinkExternal target="https://www.jetbrains.com/idea/">IDEA</LinkExternal>, as this will (in combination with
          the published <Link target="bf9d263d-a279-41bd-bfdf-78f7c3fbf7a9">configuration schema</Link>) provide instant
          validation of the configuration file, and extensive autocompletion support.
        </Paragraph>
        <Paragraph>
          We create a file at <Term type="file">/storage/northpike/etc/config.xml</Term> with the following content:
        </Paragraph>
        <FormalItem title="Configuration File">
          <Verbatim>
            <xi:include href="tutorial-file.xml"
                        parse="text"/>
          </Verbatim>
        </FormalItem>
        <Paragraph>
          Note that we use the <Link target="040f2f85-0c04-4684-bf49-e5065f800139">standard ports</Link> for TLS. If you
          skipped the section on TLS, you should use the non-TLS standard ports.
        </Paragraph>
      </Subsection>

      <Subsection title="Server Startup">
        <Paragraph>
          Given all of the items above, we can finally start the server with the given
          <Term type="command">podman</Term>
          command:
        </Paragraph>
        <FormalItem title="Startup">
          <Verbatim><![CDATA[
/usr/bin/podman \
  run \
  --name northpike01 \
  --read-only \
  --rm \
  --replace \
  --volume '/storage/northpike/etc:/northpike/etc:Z,ro' \
  --volume '/storage/northpike/data:/northpike/data:Z,rw' \
  --volume '/storage/certificates:/northpike/certificates:z,ro' \
  --network='slirp4netns:outbound_addr6=cafe:cafe::1,outbound_addr=100.100.100.100' \
  --publish '100.100.100.100:21048:21048/tcp' \
  --publish '100.100.100.100:21049:21049/tcp' \
  --publish '100.100.100.100:21050:21050/tcp' \
  --publish '[cafe:cafe::1]:21048:21048/tcp' \
  --publish '[cafe:cafe::1]:21049:21049/tcp' \
  --publish '[cafe:cafe::1]:21050:21050/tcp' \
  quay.io/io7mcom/northpike:0.0.2-SNAPSHOT \
  run --verbose trace --configuration /northpike/etc/config.xml
]]></Verbatim>
        </FormalItem>
      </Subsection>

      <Subsection title="Server Admin">
        <Paragraph>
          At this point, the server is running, but no interaction is possible with it as there are no users defined on
          the server that have any roles (such as the
          <Term type="expression">login</Term>
          role that allows a user to log in), and no defined agents.
        </Paragraph>
        <Paragraph>
          As <Link target="c6897721-eab0-447b-845c-eb85d92f5c19">mentioned earlier</Link>, we need to set the user with
          ID
          <Term type="constant">f71154c9-f7ac-472c-88fe-0c367f679a7a</Term>
          as the server adminstrator. We can use the following invocation to run the
          <Link target="1720443b-3f44-485b-b5c0-d0268d418785">set-admin</Link>
          command:
        </Paragraph>
        <FormalItem title="Startup">
          <Verbatim><![CDATA[
/usr/bin/podman \
  run \
  --read-only \
  --volume '/storage/northpike/etc:/northpike/etc:Z,ro' \
  --volume '/storage/northpike/data:/northpike/data:Z,rw' \
  --volume '/storage/certificates:/northpike/certificates:z,ro' \
  quay.io/io7mcom/northpike:0.0.2-SNAPSHOT \
  set-admin --configuration /northpike/etc/config.xml --user-id f71154c9-f7ac-472c-88fe-0c367f679a7a --user-name grouch
]]></Verbatim>
        </FormalItem>
        <Paragraph>
          The command will configure the admin user and then immediately exit.
        </Paragraph>
      </Subsection>
    </Subsection>
  </Subsection>

  <Subsection title="Shell"
              id="a6fa04cb-ccee-4c71-89f2-9b05345cef5f">
    <Subsection title="Overview">
      <Paragraph>
        With the <Link target="656d335d-211e-4979-bbaa-91ce9ad5ed8a">server</Link> now configured and running, we can
        use the <Link target="ee76b065-9857-469c-9aca-02f0f0d58a07">user shell</Link> to log into the server and
        configure it further. We'll indicate all commands that are executed in the shell by showing them with a
        <Term type="expression">[northpike]$</Term>
        prefix.
      </Paragraph>
    </Subsection>

    <Subsection title="Logging In">
      <Paragraph>
        It's possible to use the <Link target="7d69608f-4375-3727-993b-819e07c3e63d">login</Link> command to log in to
        the server, but it's likely preferable to use the various
        <Link target="01a85d22-da3c-4f18-ba11-d6e700345e4e">bookmark</Link>
        commands to define a configuration once and use it repeatedly, rather than having to repeat the login parameters
        over and over.
      </Paragraph>
      <Paragraph>
        Defining a bookmark is straightforward (note that we use
        <Link target="72cddf8d-32d7-44a9-b3d6-08eb9162a140">ALT+ENTER</Link>
        to break the command up into several lines for readability):
      </Paragraph>
      <FormalItem title="Bookmark Creation">
        <Verbatim><![CDATA[
[northpike]$ bookmark-put
--name tutorial
--hostname northpike.example.com
--port 21050
--tls TLS_ENABLED_CLIENT_ANONYMOUS
--user grouch
--password ilovetrash

[northpike]$ bookmark-list
┌───────────┬───────────────────────┬───────┬──────────────────────────────┬─────────────────────────┐
│ Name      │ Host                  │ Port  │ TLS                          │ User                    │
├───────────┼───────────────────────┼───────┼──────────────────────────────┼─────────────────────────┤
│ tutorial  │ northpike.example.com │ 21050 │ TLS_ENABLED_CLIENT_ANONYMOUS │ grouch                  │
└───────────┴───────────────────────┴───────┴──────────────────────────────┴─────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can now log in using the named bookmark:
      </Paragraph>
      <FormalItem title="Bookmark Login">
        <Verbatim><![CDATA[
[northpike]$ bookmark-login --name tutorial

[northpike]$ self
f71154c9-f7ac-472c-88fe-0c367f679a7a
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        If everything succeeds, the command says nothing. The
        <Link target="c3752e3b-b9d5-3994-8dad-5d45248697ae">self</Link>
        command shows the ID of the currently logged-in user.
      </Paragraph>
    </Subsection>
  </Subsection>

  <Subsection title="Setting Up Agents">
    <Subsection title="Overview">
      <Paragraph>
        By itself, the <Term type="package">northpike</Term> server isn't particularly useful; it merely coordinates
        work. The actual work is performed by <Link target="935b5ed1-1fbb-4d8b-9930-c5a3e79c7afd">agents</Link>. We'll
        need to set up an agent host, create one or more agents, and connect them to the server.
      </Paragraph>
      <Paragraph>
        It's recommended, but not strictly required, that agents be run on different physical (or virtual) machines to
        the server. This tutorial will be written under the assumption that the agent we set up is on a separate system
        from the server.
      </Paragraph>
      <Paragraph>
        We'll assume that the agent software has been installed at <Term type="file">/opt/northpike-agent</Term>. This
        is the standard location when using the provided <Term type="file">.deb</Term> packages.
      </Paragraph>
    </Subsection>

    <Subsection title="Users">
      <Paragraph>
        We'll assume that an unprivileged user <Term type="constant">_northpike-agent</Term> exists on the system we'll
        use to run the agents. The agents require no privileges.
      </Paragraph>
    </Subsection>

    <Subsection title="Filesystem">
      <Paragraph>
        The agent host needs space to store a fairly small internal SQLite database, and it also needs space for
        creating workspaces within which to execute tasks it receives from the server.
      </Paragraph>
      <Paragraph>
        We'll assume that the agent host has been given a decently sized volume of its own mounted at
        <Term type="file">/northpike</Term>:
      </Paragraph>
      <FormalItem title="Volume">
        <Verbatim><![CDATA[
agent-machine# df -h
/dev/mapper/linuxbuilds01--vg-northpike  196G   36K  186G   1% /northpike
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We'll set up directories to hold the database and any workspaces:
      </Paragraph>
      <FormalItem title="Directories">
        <Verbatim><![CDATA[
agent-machine# mkdir /northpike/databases
agent-machine# mkdir /northpike/workspaces
agent-machine# mkdir /northpike/temporary
agent-machine# chown -R _northpike-agent:_northpike-agent /northpike/databases
agent-machine# chown -R _northpike-agent:_northpike-agent /northpike/workspaces
agent-machine# chown -R _northpike-agent:_northpike-agent /northpike/temporary
]]></Verbatim>
      </FormalItem>
    </Subsection>

    <Subsection title="Configuration">
      <Paragraph>
        Only a very basic configuration file is required for the agent host, as most of the configuration is performed
        through the <Link target="c3b99531-ff6d-49d0-9105-ae5effd06ae6">agent shell</Link>. A minimal configuration file
        is required that tells the agent host where to store its own database, any required telemetry settings, and how
        the agent host should expose a shell. We'll expose the agent shell on
        <Term type="address">localhost</Term>
        on port <Term type="constant">20051</Term>, and we'll require that anyone connecting to it must present the
        secret access key
        <Term type="constant">8cf811bcc5a74b4a8cf10cedfc4cafb68a974b0caf01b5ef8b596c9b109966c3</Term>. We'll place the
        configuration file at <Term type="file">/etc/northpike-agent/config.xml</Term> for this example.
      </Paragraph>
      <FormalItem title="Configuration File">
        <Verbatim><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>

<c:Configuration xmlns:c="urn:com.io7m.northpike.agent.configuration:1">

  <c:Console Address="localhost"
             Port="20051"
             AccessKey="8cf811bcc5a74b4a8cf10cedfc4cafb68a974b0caf01b5ef8b596c9b109966c3"/>

  <c:Database Kind="SQLITE"
              File="/northpike/database/database.db"
              Create="true"
              Upgrade="true"/>

  <c:OpenTelemetry LogicalServiceName="northpike.agent01">
    <c:Logs    Endpoint="http://logs.example.com:4317"    Protocol="GRPC"/>
    <c:Metrics Endpoint="http://metrics.example.com:4317" Protocol="GRPC"/>
    <c:Traces  Endpoint="http://traces.example.com:4317"  Protocol="GRPC"/>
  </c:OpenTelemetry>

</c:Configuration>
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can now start the agent host:
      </Paragraph>
      <FormalItem title="Startup">
        <Verbatim><![CDATA[
agent-machine$ /opt/northpike-agent/bin/northpike-agent run \
--verbose trace \
--configuration \
/etc/northpike-agent/config.xml
]]></Verbatim>
      </FormalItem>
    </Subsection>

    <Subsection title="Shell">
      <Paragraph>
        With the agent host running, we can connect to it using the agent shell.
      </Paragraph>
      <FormalItem title="Shell">
        <Verbatim><![CDATA[
agent-machine$ /opt/northpike-agent/bin/northpike-agent shell
[northpike-agent]$
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        As we configured the agent shell service to run on <Term type="address">localhost</Term> using the
        <Link target="bec529d5-74d7-47b0-9b32-314c49715972">standard port</Link>, we only need to provide the access key
        to the <Term type="command">login</Term> command to connect to the agent:
      </Paragraph>
      <FormalItem title="Login">
        <Verbatim><![CDATA[
[northpike-agent]$ login --access-key 2053e737047446655de7a245ccf0a2b6921ab92da7a19a4065956949bf66380a
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        If everything succeeds, the command says nothing.
      </Paragraph>
    </Subsection>

    <Subsection title="Agent Creation">
      <Paragraph>
        We now need to define an agent. Agents are assigned unique names within an agent host, but the name is
        essentially unused outside the agent host; agents are globally identified with an
        <LinkExternal target="https://en.wikipedia.org/wiki/EdDSA">Ed448</LinkExternal>
        keypair. We can use the <Term type="command">agent-create</Term> command to create a new agent, and
        automatically generate a new keypair in the process:
      </Paragraph>
      <FormalItem title="Create">
        <Verbatim><![CDATA[
[northpike-agent]$ agent-create --name main

[northpike-agent]$ agent-list
┌─────────┬──────────────┬────────────────────────────────────────────────────┐
│ Agent   │ Health       │ Status                                             │
├─────────┼──────────────┼────────────────────────────────────────────────────┤
│ main    │ UNHEALTHY    │ No server configured. No work executor configured. │
└─────────┴──────────────┴────────────────────────────────────────────────────┘

[northpike-agent]$ agent-get --name main
┌──────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Attribute            │ Value                                                                                                                │
├──────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Name                 │ main                                                                                                                 │
├──────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Public Key Algorithm │ Ed448                                                                                                                │
├──────────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Public Key           │ 0000b26b71a2b52c3a43e5476e690b655b5a9546567bae526e22cc34242b0541386b7a1891d3516739f9447a395d4deb23c8a0bef3fdefaeabbf │
└──────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
    </Subsection>

    <Subsection title="Agent Connection">
      <Paragraph>
        We now need to tell the agent how to connect to the server. The agent host attempts to ensure that all agents
        that have defined servers will maintain persistent connections to the server. Right now, the agent doesn't know
        about our server, and the server doesn't know about any agents. We introduce the two to each other by first
        telling the agent about the server. The agent will attempt to connect to the server, but the server will not
        allow the agent to log in (because the server has no agents defined). The server will, however, store a
        <Term type="term">login challenge</Term>
        for the agent. We can look at the current list of
        <Term type="term">login challenges</Term>
        on the server, select the one that came from the agent we defined, and then use a single command to
        automatically create an agent definition on the server.
      </Paragraph>
      <Paragraph>
        The first step is to define a server. Servers within an agent host are uniquely identified by UUID values, so we
        pick an arbitrary unused UUID. We also specify that the agent should connect to the server using TLS.
      </Paragraph>
      <FormalItem title="Server Definition">
        <Verbatim><![CDATA[
[northpike-agent]$ server-put
--hostname northpike.example.com
--port 21048
--server ac2fc9d0-65d1-4539-8949-8d6198a7e526
--message-size-limit 1000000

[northpike-agent]$ server-set-tls --server ac2fc9d0-65d1-4539-8949-8d6198a7e526 --tls TLS_ENABLED_CLIENT_ANONYMOUS

[northpike-agent]$ server-list
┌───────────────────────────────────────────────────────────────────────────────┬─────────────────────────┐
│ ID                                                                            │ Hostname                │
├───────────────────────────────────────────────────────────────────────────────┼─────────────────────────┤
│ ac2fc9d0-65d1-4539-8949-8d6198a7e526                                          │ northpike.int.arc7.info │
└───────────────────────────────────────────────────────────────────────────────┴─────────────────────────┘

[northpike-agent]$ server-get --server ac2fc9d0-65d1-4539-8949-8d6198a7e526
┌────────────────────────────────────────────┬──────────────────────────────────────┐
│ Attribute                                  │ Value                                │
├────────────────────────────────────────────┼──────────────────────────────────────┤
│ ID                                         │ ac2fc9d0-65d1-4539-8949-8d6198a7e526 │
├────────────────────────────────────────────┼──────────────────────────────────────┤
│ Hostname                                   │ northpike.example.com                │
├────────────────────────────────────────────┼──────────────────────────────────────┤
│ Port                                       │ 21048                                │
├────────────────────────────────────────────┼──────────────────────────────────────┤
│ Message Size Limit                         │ 1000000                              │
└────────────────────────────────────────────┴──────────────────────────────────────┘
TLS
┌─────────────────────────────────────────────────────────────┬─────────────────────┐
│ Attribute                                                   │ Value               │
├─────────────────────────────────────────────────────────────┼─────────────────────┤
│ Type                                                        │ Enabled (Anonymous) │
└─────────────────────────────────────────────────────────────┴─────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We then assign the server we defined to our agent.
      </Paragraph>
      <FormalItem title="Server Assignment">
        <Verbatim><![CDATA[
[northpike-agent]$ agent-server-assign
--server ac2fc9d0-65d1-4539-8949-8d6198a7e526
--agent main
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        At this point, the agent will start repeatedly trying to connect to the server, but the server has no defined
        agents and therefore the authentication process will fail:
      </Paragraph>
      <FormalItem title="Authentication">
        <Verbatim><![CDATA[
[northpike-agent]$ agent-list
┌──────────────────────────┬──────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Agent                    │ Health       │ Status                                                                                          │
├──────────────────────────┼──────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────┤
│ main                     │ UNHEALTHY    │ Failed connection to northpike.example.com: Authentication failed. No work executor configured. │
└──────────────────────────┴──────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can use the
        <Link target="66d120fd-a08f-3c76-b440-1049fe86a593">agent-login-challenge-search-begin</Link>
        command to list the current login challenges:
      </Paragraph>
      <FormalItem title="Login Challenge">
        <Verbatim><![CDATA[
[northpike]$ agent-login-challenge-search-begin
┌─────────────────────────────────────┬──────────────────────────────────────┬───────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Time                                │ ID                                   │ Source            │ Key                                                                                                                  │
├─────────────────────────────────────┼──────────────────────────────────────┼───────────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 2024-03-10T21:44:24Z                │ 528b2fdb-c644-4b3e-a4ca-ed4f31c5ab4d │ /10.0.2.100:46088 │ 0000b26b71a2b52c3a43e5476e690b655b5a9546567bae526e22cc34242b0541386b7a1891d3516739f9447a395d4deb23c8a0bef3fdefaeabbf │
└─────────────────────────────────────┴──────────────────────────────────────┴───────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can instruct the server to define a new agent based on this login challenge. The next time the agent
        connects, it will sign the login challenge (proving that it owns the private key associated with the published
        public key), and the server will permit the login. We're required to provide an unused UUID value to identify
        the agent, and to provide a helpful name for organizational purposes. We'll use the name
        <Term type="constant">linuxbuilds01</Term> for our agent. We can see that, once the agent has authenticated,
        the agent will forward extensive information on its own composition in order to allow for
        accurate <Link target="3f9341dd-4d51-42e8-b0f5-370591e58afa">labelling</Link> by the server administrator.
      </Paragraph>
      <FormalItem title="Agent Creation">
        <Verbatim><![CDATA[
[northpike]$ agent-login-challenge-agent-create
--challenge-id 528b2fdb-c644-4b3e-a4ca-ed4f31c5ab4d
--agent-id a80de192-d860-4501-8a41-47d4abf958e8
--agent-name linuxbuilds01

[northpike]$ agent-search-begin
 Page 1 of 1, offset 0
┌─────────────────────────────────────────────────────────────────────────────┬───────────────┐
│ ID                                                                          │ Name          │
├─────────────────────────────────────────────────────────────────────────────┼───────────────┤
│ a80de192-d860-4501-8a41-47d4abf958e8                                        │ linuxbuilds01 │
└─────────────────────────────────────────────────────────────────────────────┴───────────────┘

[northpike]$ agent-get --id a80de192-d860-4501-8a41-47d4abf958e8
┌─────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Attribute                                                       │ Value                                                                                                                      │
├─────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ ID                                                              │ a80de192-d860-4501-8a41-47d4abf958e8                                                                                       │
├─────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Name                                                            │ linuxbuilds01                                                                                                              │
├─────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Public Key                                                      │ Ed448:0000b26b71a2b52c3a43e5476e690b655b5a9546567bae526e22cc34242b0541386b7a1891d3516739f9447a395d4deb23c8a0bef3fdefaeabbf │
└─────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
System Properties
┌────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Name                                           │ Value                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ file.encoding                                  │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ file.separator                                 │ /                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.class.path                                │                                                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.class.version                             │ 65.0                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.home                                      │ /opt/northpike-agent/lib/runtime                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.io.tmpdir                                 │ /tmp                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.library.path                              │ /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.runtime.name                              │ OpenJDK Runtime Environment                                                                                                                 │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.runtime.version                           │ 21.0.2+13-LTS                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.name                        │ Java Platform API Specification                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.vendor                      │ Oracle Corporation                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.version                     │ 21                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor                                    │ Eclipse Adoptium                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.url                                │ https://adoptium.net/                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.url.bug                            │ https://github.com/adoptium/adoptium-support/issues                                                                                         │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.version                            │ Temurin-21.0.2+13                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.version                                   │ 21.0.2                                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.version.date                              │ 2024-01-16                                                                                                                                  │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.compressedOopsMode                     │ Zero based                                                                                                                                  │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.info                                   │ mixed mode, sharing                                                                                                                         │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.name                                   │ OpenJDK 64-Bit Server VM                                                                                                                    │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.name                     │ Java Virtual Machine Specification                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.vendor                   │ Oracle Corporation                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.version                  │ 21                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.vendor                                 │ Eclipse Adoptium                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.version                                │ 21.0.2+13-LTS                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.debug                                      │ release                                                                                                                                     │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.main                                │ com.io7m.northpike.agent.main                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.main.class                          │ com.io7m.northpike.agent.main.NPAgentMain                                                                                                   │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.path                                │ /opt/northpike-agent/lib/app/mods                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jpackage.app-path                              │ /opt/northpike-agent/bin/northpike-agent                                                                                                    │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jpackage.app-version                           │ 0.0.2-SNAPSHOT                                                                                                                              │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ line.separator                                 │                                                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ native.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ org.jooq.no-logo                               │ true                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ org.jooq.no-tips                               │ true                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.arch                                        │ amd64                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.name                                        │ Linux                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.version                                     │ 6.1.0-18-amd64                                                                                                                              │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ path.separator                                 │ :                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ stderr.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ stdout.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.arch.data.model                            │ 64                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.boot.library.path                          │ /opt/northpike-agent/lib/runtime/lib                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.cpu.endian                                 │ little                                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.io.unicode.encoding                        │ UnicodeLittle                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.java.command                               │ com.io7m.northpike.agent.main/com.io7m.northpike.agent.main.NPAgentMain run --verbose trace --configuration /etc/northpike-agent/config.xml │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.java.launcher                              │ SUN_STANDARD                                                                                                                                │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.jnu.encoding                               │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.management.compiler                        │ HotSpot 64-Bit Tiered Compilers                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.country                                   │ GB                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.dir                                       │ /                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.home                                      │ /home/_northpike-agent                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.language                                  │ en                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.name                                      │ _northpike-agent                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.timezone                                  │ Europe/London                                                                                                                               │
└────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
Environment Variables
┌────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Name                                           │ Value                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ file.encoding                                  │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ file.separator                                 │ /                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.class.path                                │                                                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.class.version                             │ 65.0                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.home                                      │ /opt/northpike-agent/lib/runtime                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.io.tmpdir                                 │ /tmp                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.library.path                              │ /usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.runtime.name                              │ OpenJDK Runtime Environment                                                                                                                 │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.runtime.version                           │ 21.0.2+13-LTS                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.name                        │ Java Platform API Specification                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.vendor                      │ Oracle Corporation                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.specification.version                     │ 21                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor                                    │ Eclipse Adoptium                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.url                                │ https://adoptium.net/                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.url.bug                            │ https://github.com/adoptium/adoptium-support/issues                                                                                         │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vendor.version                            │ Temurin-21.0.2+13                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.version                                   │ 21.0.2                                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.version.date                              │ 2024-01-16                                                                                                                                  │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.compressedOopsMode                     │ Zero based                                                                                                                                  │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.info                                   │ mixed mode, sharing                                                                                                                         │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.name                                   │ OpenJDK 64-Bit Server VM                                                                                                                    │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.name                     │ Java Virtual Machine Specification                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.vendor                   │ Oracle Corporation                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.specification.version                  │ 21                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.vendor                                 │ Eclipse Adoptium                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ java.vm.version                                │ 21.0.2+13-LTS                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.debug                                      │ release                                                                                                                                     │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.main                                │ com.io7m.northpike.agent.main                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.main.class                          │ com.io7m.northpike.agent.main.NPAgentMain                                                                                                   │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jdk.module.path                                │ /opt/northpike-agent/lib/app/mods                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jpackage.app-path                              │ /opt/northpike-agent/bin/northpike-agent                                                                                                    │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ jpackage.app-version                           │ 0.0.2-SNAPSHOT                                                                                                                              │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ line.separator                                 │                                                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ native.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ org.jooq.no-logo                               │ true                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ org.jooq.no-tips                               │ true                                                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.arch                                        │ amd64                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.name                                        │ Linux                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ os.version                                     │ 6.1.0-18-amd64                                                                                                                              │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ path.separator                                 │ :                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ stderr.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ stdout.encoding                                │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.arch.data.model                            │ 64                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.boot.library.path                          │ /opt/northpike-agent/lib/runtime/lib                                                                                                        │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.cpu.endian                                 │ little                                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.io.unicode.encoding                        │ UnicodeLittle                                                                                                                               │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.java.command                               │ com.io7m.northpike.agent.main/com.io7m.northpike.agent.main.NPAgentMain run --verbose trace --configuration /etc/northpike-agent/config.xml │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.java.launcher                              │ SUN_STANDARD                                                                                                                                │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.jnu.encoding                               │ UTF-8                                                                                                                                       │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ sun.management.compiler                        │ HotSpot 64-Bit Tiered Compilers                                                                                                             │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.country                                   │ GB                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.dir                                       │ /                                                                                                                                           │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.home                                      │ /home/_northpike-agent                                                                                                                      │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.language                                  │ en                                                                                                                                          │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.name                                      │ _northpike-agent                                                                                                                            │
├────────────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ user.timezone                                  │ Europe/London                                                                                                                               │
└────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        With the agent now defined on the server, the agent successfully authenticates within a second:
      </Paragraph>
      <FormalItem title="Agent Connected">
        <Verbatim><![CDATA[
[northpike]$ agents-connected
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ ID                                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│ a80de192-d860-4501-8a41-47d4abf958e8                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        In the agent shell, the agent is shown as being connected:
      </Paragraph>
      <FormalItem title="Agent Shell Connected">
        <Verbatim><![CDATA[
[northpike-agent]$ agent-list
┌─────────────────────────────────┬──────────────┬───────────────────────────────────────────────────────────────────────────────────────────┐
│ Agent                           │ Health       │ Status                                                                                    │
├─────────────────────────────────┼──────────────┼───────────────────────────────────────────────────────────────────────────────────────────┤
│ main                            │ UNHEALTHY    │ Connected to northpike.example.com (Latency PT0.009468775S). No work executor configured. │
└─────────────────────────────────┴──────────────┴───────────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        The agent is still listed as <Term type="constant">UNHEALTHY</Term> as we have not configured a
        <Link target="35f12f1c-5edc-4724-8a50-d330c3defb92">work executor</Link>
        for the agent. Configuring a work executor is the next step.
      </Paragraph>
    </Subsection>

    <Subsection title="Work Executors">
      <Paragraph>
        An agent has at most one <Link target="35f12f1c-5edc-4724-8a50-d330c3defb92">work executor</Link>. Our current
        agent is marked as <Term type="constant">UNHEALTHY</Term> because we haven't configured a work executor. The
        supported types of work executors can be listed:
      </Paragraph>
      <FormalItem title="Supported Executors">
        <Verbatim><![CDATA[
[northpike-agent]$ work-executors-supported
┌──────────────────────────────────────────────────────┬─────────────────────────────────────┐
│ Name                                                 │ Description                         │
├──────────────────────────────────────────────────────┼─────────────────────────────────────┤
│ workexec.podman                                      │ Podman containerized work executor. │
├──────────────────────────────────────────────────────┼─────────────────────────────────────┤
│ workexec.local                                       │ Local work executor.                │
└──────────────────────────────────────────────────────┴─────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        The <Term type="constant">workexec.local</Term> executor is a simple executor that runs tools directly on the
        host system without any kind of containerization. It's the simplest option for executing work, but it doesn't
        provide any kind of isolation between tasks running on the same host system
        <LinkFootnote target="e1be95e9-5f0f-434f-8ad7-427712797888"/>. The
        <Term type="constant">workexec.podman</Term>
        executor is a
        <LinkExternal target="https://podman.io/">Podman</LinkExternal>-based executor that executes build tasks inside
        isolated container instances. The <Term type="constant">workexec.podman</Term> executor therefore gives much
        stronger isolation between build tasks running on the same system, but may not be suitable for some types of
        tasks. For example, if the test suite of a particular project requires creating containers, then it is much
        harder to configure this to work correctly (if it is possible at all) when the test suite is already running
        inside a container.
      </Paragraph>
      <Paragraph>
        For this tutorial, we'll add a simple local executor:
      </Paragraph>
      <FormalItem title="Local Executor">
        <Verbatim><![CDATA[
[northpike-agent]$ agent-work-executor-put
--agent main
--type workexec.local
--work-directory /northpike/workspaces
--temporary-directory /northpike/temporary

[northpike-agent]$ agent-list
┌───────┬──────────────┬──────────────────────────────────────────────────────────────────────────────────────┐
│ Agent │ Health       │ Status                                                                               │
├───────┼──────────────┼──────────────────────────────────────────────────────────────────────────────────────┤
│ main  │ HEALTHY      │ Connected to northpike.example.com (Latency PT0.002096614S). Work executor is ready. │
└───────┴──────────────┴──────────────────────────────────────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        Our agent is now fully configured and ready to accept work.
      </Paragraph>
    </Subsection>
  </Subsection>

  <Subsection title="Setting Up Work">
    <Subsection title="Repositories">
      <Paragraph>
        In order to do useful work such as building code, we'll need to tell the server how to actually get that code.
        We'll add the <LinkExternal target="https://www.github.com/io7m-com/abstand">abstand</LinkExternal> repository to
        the server as it's a fairly small and self-contained project that builds quickly. The repository is a
        <LinkExternal target="https://www.git-scm.com">Git</LinkExternal>
        repository, so we'll need to use an appropriate <Term type="term">SCM provider</Term> to access the repository.
        The
        <Link target="2bd6b7d1-85b7-3a84-9445-ce9fe89e7068">scm-providers-supported</Link>
        command lists the available providers:
      </Paragraph>
      <FormalItem title="Repository Creation">
        <Verbatim><![CDATA[
[northpike]$ scm-providers-supported
┌────────────────────────────────────┬───────────────────────────┬────────────────────────────────────┐
│ Name                               │ URI                       │ Description                        │
├────────────────────────────────────┼───────────────────────────┼────────────────────────────────────┤
│ com.io7m.northpike.repository.jgit │ https://eclipse.dev/jgit/ │ Eclipse JGit for Git repositories. │
└────────────────────────────────────┴───────────────────────────┴────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We'll use the
        <Link target="29a0885f-9292-3820-8089-fabed0903981">repository-put</Link>
        command to define the repository using the right SCM provider:
      </Paragraph>
      <FormalItem title="Repository Creation">
        <Verbatim><![CDATA[
[northpike]$ repository-put
--id 591ec9f7-5afb-4416-8258-22f388be40ff
--provider com.io7m.northpike.repository.jgit
--uri https://www.github.com/io7m-com/abstand

[northpike]$ repository-search-begin
 Page 1 of 1, offset 0
┌──────────────────────────────────────┬────────────────────────────────────┬─────────────────────────────────────────┐
│ ID                                   │ Provider                           │ URI                                     │
├──────────────────────────────────────┼────────────────────────────────────┼─────────────────────────────────────────┤
│ 591ec9f7-5afb-4416-8258-22f388be40ff │ com.io7m.northpike.repository.jgit │ https://www.github.com/io7m-com/abstand     │
└──────────────────────────────────────┴────────────────────────────────────┴─────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        The <Term type="package">abstand</Term> repository contains commits that are
        <LinkExternal target="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">PGP</LinkExternal>
        signed. It would therefore be a good idea to set the signing policy of the repository to require that only
        commits signed by specific keys are allowed to be used by the <Term type="package">northpike</Term> server. At
        the time of writing, all the commits in the <Term type="package">abstand</Term> repository are signed with the
        PGP key that has the fingerprint
        <Term type="expression">E362 BB4F 16A9 981D E781 2F6E 10E4 AAD0 B00D 6CDD</Term>. This key can be found on
        the <LinkExternal target="https://keyserver.ubuntu.com/pks/lookup?search=E362BB4F16A9981DE7812F6E10E4AAD0B00D6CDD&amp;op=index">
        public keyservers</LinkExternal>.
      </Paragraph>
      <Paragraph>
        We download the key to a file, and then import it using the shell:
      </Paragraph>
      <FormalItem title="Key Download">
        <Verbatim><![CDATA[
$ wget -O E362BB4F16A9981DE7812F6E10E4AAD0B00D6CDD.asc 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xe362bb4f16a9981de7812f6e10e4aad0b00d6cdd'

$ file E362BB4F16A9981DE7812F6E10E4AAD0B00D6CDD.asc
E362BB4F16A9981DE7812F6E10E4AAD0B00D6CDD.asc: PGP public key block
]]></Verbatim>
      </FormalItem>
      <FormalItem title="Key Upload">
        <Verbatim><![CDATA[
[northpike]$ public-key-put --file E362BB4F16A9981DE7812F6E10E4AAD0B00D6CDD.asc

[northpike]$ public-key-search-begin
 Page 1 of 1, offset 0
┌─────────────────────────────────────────────────┬──────────────────────┬──────────────────────┬────────────────────────────────┐
│ Fingerprint                                     │ Time Created         │ Time Expires         │ User ID                        │
├─────────────────────────────────────────────────┼──────────────────────┼──────────────────────┼────────────────────────────────┤
│ e362bb4f16a9981de7812f6e10e4aad0b00d6cdd        │ 2024-01-01T16:15:22Z │ 2025-01-01T12:00:18Z │ Mark Raynsford (2024 person... │
└─────────────────────────────────────────────────┴──────────────────────┴──────────────────────┴────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We then assign the public key to the repository. Repositories may have any number of keys assigned.
      </Paragraph>
      <FormalItem title="Key Assignment">
        <Verbatim><![CDATA[
[northpike]$ repository-public-key-assign
--repository 591ec9f7-5afb-4416-8258-22f388be40ff
--key e362bb4f16a9981de7812f6e10e4aad0b00d6cdd

[northpike]$ repository-public-keys-assigned --repository 591ec9f7-5afb-4416-8258-22f388be40ff
┌─────────────────────────────────────────────────┬──────────────────────────────────────────┐
│ Attribute                                       │ Value                                    │
├─────────────────────────────────────────────────┼──────────────────────────────────────────┤
│ Fingerprint                                     │ e362bb4f16a9981de7812f6e10e4aad0b00d6cdd │
└─────────────────────────────────────────────────┴──────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We then update the repository's
        <Link target="a8871c5e-98ca-48e8-b577-afad7b94848c">signature policy</Link>
        to specify that only commits that have been signed with the exact keys assigned to the repository are allowed to
        be processed. The <Term type="constant">REQUIRE_COMMITS_SIGNED_WITH_SPECIFIC_KEYS</Term> policy will cause the
        server to refuse to process any commits that are not signed with one of the public keys that have been assigned
        to the repository.
      </Paragraph>
      <FormalItem title="Signature Policy">
        <Verbatim><![CDATA[
[northpike]$ repository-public-key-assign
--repository 591ec9f7-5afb-4416-8258-22f388be40ff
--key e362bb4f16a9981de7812f6e10e4aad0b00d6cdd
--signing-policy REQUIRE_COMMITS_SIGNED_WITH_SPECIFIC_KEYS
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can summarize all the changes we've made so far:
      </Paragraph>
      <FormalItem title="Repository Display">
        <Verbatim><![CDATA[
[northpike]$ repository-get --id 591ec9f7-5afb-4416-8258-22f388be40ff
┌───────────────────────────────────────────────┬───────────────────────────────────────────┐
│ Attribute                                     │ Value                                     │
├───────────────────────────────────────────────┼───────────────────────────────────────────┤
│ Repository ID                                 │ 591ec9f7-5afb-4416-8258-22f388be40ff      │
├───────────────────────────────────────────────┼───────────────────────────────────────────┤
│ SCM Provider                                  │ com.io7m.northpike.repository.jgit        │
├───────────────────────────────────────────────┼───────────────────────────────────────────┤
│ URI                                           │ https://www.github.com/io7m-com/abstand       │
├───────────────────────────────────────────────┼───────────────────────────────────────────┤
│ Credentials                                   │ CREDENTIALS_NONE                          │
├───────────────────────────────────────────────┼───────────────────────────────────────────┤
│ Signing Policy                                │ REQUIRE_COMMITS_SIGNED_WITH_SPECIFIC_KEYS │
└───────────────────────────────────────────────┴───────────────────────────────────────────┘

[northpike]$ repository-public-keys-assigned --repository 591ec9f7-5afb-4416-8258-22f388be40ff
┌────────────────────────────────────────────────┬──────────────────────────────────────────┐
│ Attribute                                      │ Value                                    │
├────────────────────────────────────────────────┼──────────────────────────────────────────┤
│ Fingerprint                                    │ e362bb4f16a9981de7812f6e10e4aad0b00d6cdd │
└────────────────────────────────────────────────┴──────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        When it comes to performing tasks, a repository defines the <Term type="term">where</Term> and the
        <Term type="term">what</Term>
        for the task. We now need to define the
        <Term type="term">when</Term>, the <Term type="term">how</Term>, and the <Term type="term">who</Term>. The
        <Term type="term">how</Term>
        and the <Term type="term">who</Term> are specified by
        <Link target="d9765a57-e6f1-47bf-bd53-50cbfcb186ba">plans</Link>, while the
        <Term type="term">when</Term>
        is given by
        <Link target="b8fb5b8f-a181-4de4-bec9-b4bd98bf7354">assignments</Link>. Assignments depend upon plans, so we'll
        handle the plan first.
      </Paragraph>
    </Subsection>

    <Subsection title="Plans"
                id="d9765a57-e6f1-47bf-bd53-50cbfcb186ba">
      <Paragraph>
        <Link target="7b6d8296-cba1-448b-96e0-10e89b61bec0">Plans</Link>
        describe the series of tasks that have to be performed in order to achieve a desired goal. In our case, we have
        a fairly simple goal: Build the
        <LinkExternal target="https://www.github.com/io7m-com/abstand">abstand</LinkExternal>
        project and run its test suite.
      </Paragraph>
      <Paragraph>
        In order to do this, we'll have to write a <Term type="term">plan</Term>. The plan will contain a single task
        that simply executes the build tool used for <Term type="package">abstand</Term>. The
        <Term type="package">abstand</Term>
        project uses the
        <LinkExternal target="https://maven.apache.org/">Apache Maven</LinkExternal>
        build system, so we'll need to work out which
        <Term type="package">northpike</Term>
        <Link target="fc06253c-8194-4a04-8d65-7bc2de2e7ea9">tool</Link>
        provides Apache Maven support. At the time of writing, this is fairly easy as
        <Term type="package">northpike</Term>
        only provides support for a tiny handful of tools. Apache Maven is, in fact, the only tool available on the
        server used to write this tutorial:
      </Paragraph>
      <FormalItem title="Tool Search">
        <Verbatim><![CDATA[
[northpike]$ tool-search-begin
 Page 1 of 1, offset 0
┌───────────────────────────────────┬───────────────────────────────────────────────────────┐
│ Name                              │ Description                                           │
├───────────────────────────────────┼───────────────────────────────────────────────────────┤
│ org.apache.maven                  │ Tool service for org.apache.maven (Apache Maven 3.*). │
└───────────────────────────────────┴───────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        In order to actually execute a tool, we need to provide a
        <Link target="c9234354-ea97-4693-826c-a3ccd9a006d7">tool execution</Link>. A tool execution can simply be
        thought of as a function that, when evaluated, yields a list of arguments that will be passed to the tool in
        order to execute it. It's possible to define custom tool executions but, thanks to Apache Maven's philosophy of
        having all projects build in the same manner, we can use one of the existing default tool executions to build
        the project.
      </Paragraph>
      <FormalItem title="Tool Get">
        <Verbatim><![CDATA[
[northpike]$ tool-execution-search-begin
 Page 1 of 1, offset 0
┌──────────────────────┬─────────┬──────────────────┬──────────────────────────────────────┐
│ Name                 │ Version │ Tool             │ Description                          │
├──────────────────────┼─────────┼──────────────────┼──────────────────────────────────────┤
│ clean-verify         │ 0       │ org.apache.maven │ Built-in clean-verify execution      │
├──────────────────────┼─────────┼──────────────────┼──────────────────────────────────────┤
│ clean-verify-site    │ 0       │ org.apache.maven │ Built-in clean-verify-site execution │
├──────────────────────┼─────────┼──────────────────┼──────────────────────────────────────┤
│ deploy               │ 0       │ org.apache.maven │ Built-in deploy execution            │
└──────────────────────┴─────────┴──────────────────┴──────────────────────────────────────┘

[northpike]$ tool-get --name org.apache.maven
┌───────────────────────────────────┬───────────────────────────────────────────────────────┐
│ Attribute                         │ Value                                                 │
├───────────────────────────────────┼───────────────────────────────────────────────────────┤
│ Name                              │ org.apache.maven                                      │
├───────────────────────────────────┼───────────────────────────────────────────────────────┤
│ Description                       │ Tool service for org.apache.maven (Apache Maven 3.*). │
├───────────────────────────────────┼───────────────────────────────────────────────────────┤
│ Versions Supported                │ [3.9.1, 4.0.0)                                        │
└───────────────────────────────────┴───────────────────────────────────────────────────────┘
Tool Executions
┌───────────────────────────────────────────────────────┬───────────────────────────────────┐
│ Name                                                  │ Arguments                         │
├───────────────────────────────────────────────────────┼───────────────────────────────────┤
│ clean-verify                                          │ [-C, -e, -U, clean, verify]       │
├───────────────────────────────────────────────────────┼───────────────────────────────────┤
│ clean-verify-site                                     │ [-C, -e, -U, clean, verify, site] │
├───────────────────────────────────────────────────────┼───────────────────────────────────┤
│ deploy                                                │ [-C, -e, -U, deploy]              │
└───────────────────────────────────────────────────────┴───────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        The <Term type="function">clean-verify</Term> execution is the standard execution we'll use.
      </Paragraph>
      <Paragraph>
        The following trivial plan
        <LinkFootnote target="0342eb72-d6ce-43e1-bcc8-068fa342fd15"/>
        is enough to build the project:
      </Paragraph>
      <FormalItem title="Plan">
        <Verbatim>
          <xi:include href="tutorial-plan.xml"
                      parse="text"/>
        </Verbatim>
      </FormalItem>
      <Paragraph>
        The plan defines a single task called <Term type="constant">build</Term> that runs the
        <Term type="function">clean-verify</Term>
        execution of the
        <Term type="package">org.apache.maven</Term>
        tool. We constrain the version of Apache Maven to <Term type="constant">3.9.1</Term>; this version of Apache
        Maven will be installed into the workspace before the task executes on whatever agent is assigned to execute it.
        We're also required to specify a bit of boilerplate. Firstly, we specify that the build must wait no longer than
        15 minutes for an agent to become available to execute the task. Secondly, we specify that, once a task has
        begun executing on an agent, it must complete within ten minutes. Lastly, we specify a
        <Link target="912cce33-462d-4297-a67f-73b3173fa2b6">clean policy</Link>
        for the
        <Term type="constant">build</Term>
        task that will instruct the agent to clean up the build workspace immediately after executing. The
        <Term type="constant">build</Term>
        task doesn't specify any constraints on the agents that will be used to execute it, so any agent that happens to
        be connected to the server will be eligible to execute the task.
      </Paragraph>
      <Paragraph>
        With the plan above written to a file called <Term type="file">plan-tutorial.xml</Term>, we now need to upload
        the plan to the server. The server needs us to specify what format the plan is written in (although currently
        the only supported format is the version 1 XML plan format):
      </Paragraph>
      <FormalItem title="Plan Formats">
        <Verbatim><![CDATA[
[northpike]$ plan-formats-supported
┌─────────────────────────────────────────────────────────────────┬─────────────────────────┐
│ Name                                                            │ Description             │
├─────────────────────────────────────────────────────────────────┼─────────────────────────┤
│ com.io7m.northpike.plans.parsers.v1                             │ The v1 XML Plan format. │
└─────────────────────────────────────────────────────────────────┴─────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can ask the server to validate the plan before we upload it (this is not strictly required as the server will
        validate the plan before saving it to the database anyway):
      </Paragraph>
      <FormalItem title="Plan Validate">
        <Verbatim><![CDATA[
[northpike]$ plan-validate
--file tutorial-plan.xml
--format-name com.io7m.northpike.plans.parsers.v1

Validation succeeded.
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        Uploading the plan is straightforward:
      </Paragraph>
      <FormalItem title="Plan Upload">
        <Verbatim><![CDATA[
[northpike]$ plan-put
--file tutorial-plan.xml
--format-name com.io7m.northpike.plans.parsers.v1
--name com.northpike.tutorial
--version 1

[northpike]$ plan-search-begin
 Page 1 of 1, offset 0
┌────────────────────────┬─────────┬───────────────────────────────────────────────────────┐
│ Name                   │ Version │ Description                                           │
├────────────────────────┼─────────┼───────────────────────────────────────────────────────┤
│ com.northpike.tutorial │ 1       │ An example plan.                                      │
└────────────────────────┴─────────┴───────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>

      <Paragraph>
        With a repository defined, we now have the <Term type="term">where</Term> and the
        <Term type="term">what</Term>
        will be built. With the plan defined, we also have the
        <Term type="term">who</Term>
        ("anyone", given that we didn't define any agent constraints in the plan) and the
        <Term type="term">how</Term>. We now need to define the <Term type="term">when</Term>, otherwise nothing will
        ever cause our plan to be executed.
      </Paragraph>
    </Subsection>

    <Subsection title="Assignments"
                id="b8fb5b8f-a181-4de4-bec9-b4bd98bf7354">
      <Paragraph>
        We now need to define an <Link target="abbcfc20-95ca-4f09-b795-74d1fd1538f0">assignment</Link> in order
        to actually have the system execute our plan.
      </Paragraph>
      <Paragraph>
        We'll specify that we want our assignment to be scheduled for execution on an hourly basis. When an
        assignment is scheduled for execution, the system updates the
        <Link target="679205fa-85e3-437c-a84d-0b691b6291dc">repository</Link> associated with the assignment,
        checks to see if there are any new commits that have not yet been built, and then schedules one plan
        execution for each new commit. We'll use the
        <Link target="376736fb-f2c2-4f46-b8b3-5c4d38e9393f">HOURLY_HASHED</Link> schedule to achieve this.
        Creating the assignment is straightforward:
      </Paragraph>
      <FormalItem title="Assignment Creation">
        <Verbatim><![CDATA[
[northpike]$ assignment-put
--plan com.northpike.tutorial:1
--repository 591ec9f7-5afb-4416-8258-22f388be40ff
--name com.northpike.tutorial.assignment
--schedule HOURLY_HASHED

[northpike]$ assignment-search-begin
 Page 1 of 1, offset 0
┌───────────────────────────────────┬──────────────────────────┬──────────────────────────────────────┬─────────────────────────────────────────────────────┐
│ Name                              │ Plan                     │ Repository                           │ Schedule                                            │
├───────────────────────────────────┼──────────────────────────┼──────────────────────────────────────┼─────────────────────────────────────────────────────┤
│ com.northpike.tutorial.assignment │ com.northpike.tutorial 1 │ 591ec9f7-5afb-4416-8258-22f388be40ff │ HourlyHashed (Commit age cutoff: 2024-03-17T00:00Z) │
└───────────────────────────────────┴──────────────────────────┴──────────────────────────────────────┴─────────────────────────────────────────────────────┘
]]></Verbatim>
      </FormalItem>
      <Paragraph>
        We can see that, by default, the command specifies a <Term type="term">commit age cutoff</Term> such that
        commits created earlier than the past 24 hours will not be built. The purpose of this is to avoid having
        the system schedule potentially thousands of builds if a very large/old repository is added to the system.
        The commit age cutoff can be specified manually with the
        <Term type="parameter">--schedule-commit-age-cutoff</Term> option if desired.
      </Paragraph>
    </Subsection>
  </Subsection>

  <Footnote id="a927fac5-f2e2-4f62-a61b-3f97597b80e7">
    This section of the documentation should be considered as purely informative and not normative; should there be
    inconsistencies between commands or semantics described here, and commands or semantics as described in the rest of
    the documentation, the rest of the documentation should take precedence.
  </Footnote>

  <Footnote id="e1be95e9-5f0f-434f-8ad7-427712797888">
    Isolation between build tasks on a machine is required for compliance with
    <LinkExternal target="https://slsa.dev/spec/v1.0/levels#build-l3">SLSA L3</LinkExternal>.
  </Footnote>

  <Footnote id="0342eb72-d6ce-43e1-bcc8-068fa342fd15">
    The XML-based <Link target="352ba8b4-1d9d-443c-929a-21027c374207">Plan</Link> language has a strict XML schema and,
    as such, it is recommended that Plan language programs be edited in a modern IDE such
    as <LinkExternal target="https://www.jetbrains.com/idea/">Intellij IDEA</LinkExternal>. With the Plan XML schema
    loaded into the IDE, Plan language programs can be edited with realtime validation and extensive autocompletion.
  </Footnote>

</Section>